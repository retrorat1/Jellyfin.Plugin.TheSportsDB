<div data-role="page" class="type-interior pluginConfigurationPage TheSportsDBConfigurationPage"
    data-require="emby-input,emby-button,emby-select,emby-checkbox"
    style="position: relative; z-index: 10; pointer-events: auto; background-color: transparent;">
    <style>
        .TheSportsDBConfigurationPage form {
            pointer-events: auto !important;
            z-index: 100 !important;
            position: relative;
        }

        .TheSportsDBConfigurationPage input,
        .TheSportsDBConfigurationPage button {
            pointer-events: auto !important;
        }

        #leagueMappingList {
            margin-top: 20px;
        }

        .mappingItem {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .mappingItem input {
            flex: 1;
            margin-right: 10px;
        }

        .mappingItem button {
            flex: 0 0 auto;
        }
    </style>
    <div data-role="content">
        <div class="content-primary">
            <form class="TheSportsDBConfigForm">
                <div class="inputContainer">
                    <label class="inputLabel" for="TheSportsDBApiKey">TheSportsDB API Key</label>
                    <input id="TheSportsDBApiKey" name="TheSportsDBApiKey" type="text" is="emby-input" />
                    <div class="fieldDescription">TheSportsDB API Key (default: 3 for testing)</div>
                </div>

                <div class="inputContainer">
                    <h2>League Mappings</h2>
                    <p class="fieldDescription">Map your custom folder names (e.g., "EPL", "SÃ¼per Lig") to TheSportsDB
                        League
                        IDs.</p>
                    <div id="leagueMappingList">
                        <!-- Mappings will be injected here -->
                    </div>
                    <button is="emby-button" type="button" class="raised"
                        onclick="TheSportsDBConfigurationPage.addMapping()">
                        <span>Add Mapping</span>
                    </button>
                    <div class="fieldDescription">
                        You can find League IDs on <a href="https://www.thesportsdb.com"
                            target="_blank">TheSportsDB.com</a> (e.g. English Premier League is 4328).
                    </div>
                </div>

                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="text/javascript">
        var TheSportsDBConfigurationPage = {
            pluginId: '5fce2032-15f1-4171-4141-86105f201010', // Must match Plugin.Id

            update: function (page) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(TheSportsDBConfigurationPage.pluginId).then(function (config) {
                    // Handle Case Sensitivity (API usually returns camelCase)
                    var apiKey = config.ApiKey || config.apiKey;
                    if (!apiKey) apiKey = '3';

                    var mappings = config.LeagueMappings || config.leagueMappings || [];

                    page.querySelector('#TheSportsDBApiKey').value = apiKey;

                    // Render Mappings
                    var list = page.querySelector('#leagueMappingList');
                    list.innerHTML = '';
                    mappings.forEach(function (m) {
                        var name = m.Name || m.name || '';
                        var id = m.LeagueId || m.leagueId || '';
                        TheSportsDBConfigurationPage.renderMapping(list, name, id);
                    });

                    Dashboard.hideLoadingMsg();
                });
            },

            save: function (page) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(TheSportsDBConfigurationPage.pluginId).then(function (config) {
                    var apiKey = page.querySelector('#TheSportsDBApiKey').value;

                    // We need to set the property that the server expects. 
                    // To be safe, we try to set both or detect which one exists, but usually simple assignment is fine 
                    // if we respect the case the server sent, or just set both to be sure.
                    config.ApiKey = apiKey;
                    config.apiKey = apiKey;

                    // Mappings
                    var newMappings = [];
                    var items = page.querySelectorAll('.mappingItem');
                    items.forEach(function (item) {
                        var name = item.querySelector('.mappingName').value;
                        var id = item.querySelector('.mappingId').value;
                        if (name && id) {
                            newMappings.push({ Name: name, LeagueId: id, name: name, leagueId: id });
                        }
                    });

                    config.LeagueMappings = newMappings;
                    config.leagueMappings = newMappings;

                    ApiClient.updatePluginConfiguration(TheSportsDBConfigurationPage.pluginId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
            },

            addMapping: function () {
                var list = document.querySelector('#leagueMappingList');
                if (list) {
                    TheSportsDBConfigurationPage.renderMapping(list, '', '');
                }
            },

            renderMapping: function (container, name, id) {
                var div = document.createElement('div');
                div.className = 'mappingItem';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.marginBottom = '10px';

                div.innerHTML = `
                    <div style="flex-grow:1; margin-right:10px;">
                        <input type="text" is="emby-input" class="mappingName" label="Folder Name" value="${name}" />
                    </div>
                    <div style="flex-grow:1; margin-right:10px;">
                        <input type="text" is="emby-input" class="mappingId" label="League ID" value="${id}" />
                    </div>
                    <button type="button" is="emby-button" class="raised" onclick="this.closest('.mappingItem').remove()">Remove</button>
                `;
                container.appendChild(div);
            }
        };

        (function () {
            var page = document.querySelector('.TheSportsDBConfigurationPage');
            if (page) {
                // Remove any existing listeners to prevent duplicates (using specialized event namespace if jQuery was available, but here we just re-add)
                // Actually in vanilla JS, we rely on pageshow behaving.

                var onPageShow = function () {
                    var form = page.querySelector('.TheSportsDBConfigForm');
                    // Use onsubmit to ensure single listener
                    form.onsubmit = function (e) {
                        e.preventDefault();
                        TheSportsDBConfigurationPage.save(page);
                        return false;
                    };

                    // Also attach to the button directly as a fallback
                    var btn = page.querySelector('.button-submit');
                    if (btn) {
                        btn.onclick = function (e) {
                            e.preventDefault();
                            TheSportsDBConfigurationPage.save(page);
                            return false;
                        };
                    }

                    TheSportsDBConfigurationPage.update(page);
                };

                page.addEventListener('pageshow', onPageShow);

                // If page is already visible (sometimes pageshow is missed), run it now
                if (!page.getAttribute('data-pageshow-initialized')) {
                    page.setAttribute('data-pageshow-initialized', 'true');
                    onPageShow();
                }
            }
        })();
    </script>
</div>