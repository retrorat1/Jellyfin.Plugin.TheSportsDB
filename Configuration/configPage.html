<div data-role="page" class="type-interior pluginConfigurationPage TheSportsDBConfigurationPage"
    data-require="emby-input,emby-button,emby-select,emby-checkbox"
    style="position: relative; z-index: 10; pointer-events: auto; background-color: transparent;">
    <style>
        .TheSportsDBConfigurationPage form {
            pointer-events: auto !important;
            z-index: 100 !important;
            position: relative;
        }

        .TheSportsDBConfigurationPage input,
        .TheSportsDBConfigurationPage button {
            pointer-events: auto !important;
        }

        #leagueMappingList {
            margin-top: 20px;
        }

        .mappingItem {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .mappingItem input {
            flex: 1;
            margin-right: 10px;
        }

        .mappingItem button {
            flex: 0 0 auto;
        }
    </style>
    <div data-role="content">
        <div class="content-primary">
            <form class="TheSportsDBConfigForm">
                <div class="inputContainer">
                    <label class="inputLabel" for="TheSportsDBApiKey">TheSportsDB API Key</label>
                    <input id="TheSportsDBApiKey" name="TheSportsDBApiKey" type="text" is="emby-input" />
                    <div class="fieldDescription">TheSportsDB API Key (default: 3 for testing)</div>
                </div>

                <div class="inputContainer">
                    <h2>League Mappings</h2>
                    <p class="fieldDescription">Map your custom folder names (e.g., "EPL", "Süper Lig") to TheSportsDB
                        League
                        IDs.</p>
                    <div id="leagueMappingList">
                        <!-- Mappings will be injected here -->
                    </div>
                    <button is="emby-button" type="button" class="raised"
                        onclick="TheSportsDBConfigurationPage.addMapping()">
                        <span>Add Mapping</span>
                    </button>
                    <div class="fieldDescription">
                        You can find League IDs on <a href="https://www.thesportsdb.com"
                            target="_blank">TheSportsDB.com</a> (e.g. English Premier League is 4328).
                    </div>
                </div>

                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="text/javascript">
        var TheSportsDBConfigurationPage = {
            pluginId: '5fce2032-15f1-4171-4141-86105f201010', // Must match Plugin.Id

            // Renders mapping list from config
            update: function (page) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(TheSportsDBConfigurationPage.pluginId).then(function (config) {
                    var apiKey = config.ApiKey || config.apiKey;
                    if (!apiKey) apiKey = '3';

                    var mappings = config.LeagueMappings || config.leagueMappings || [];

                    page.querySelector('#TheSportsDBApiKey').value = apiKey;

                    // Render Mappings preserving values
                    var list = page.querySelector('#leagueMappingList');
                    list.innerHTML = '';
                    mappings.forEach(function (m) {
                        var name = m.Name || m.name || '';
                        var id = m.LeagueId || m.leagueId || '';
                        var row = document.createElement('div');
                        row.className = 'mappingItem';

                        var nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.className = 'mappingName';
                        nameInput.placeholder = 'Custom Name (EPL, NFL, UFC)';
                        nameInput.value = name;

                        var idInput = document.createElement('input');
                        idInput.type = 'text';
                        idInput.className = 'mappingId';
                        idInput.placeholder = 'League ID (e.g. 4328)';
                        idInput.value = id;

                        // Delete button
                        var delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.textContent = '✖';
                        delBtn.onclick = function () {
                            row.remove();
                        };

                        row.appendChild(nameInput);
                        row.appendChild(idInput);
                        row.appendChild(delBtn);
                        list.appendChild(row);
                    });
                }).finally(function () {
                    Dashboard.hideLoadingMsg();
                });
            },

            addMapping: function () {
                var list = document.querySelector('#leagueMappingList');
                var row = document.createElement('div');
                row.className = 'mappingItem';

                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'mappingName';
                nameInput.placeholder = 'Custom Name (EPL, NFL, UFC)';
                nameInput.value = '';

                var idInput = document.createElement('input');
                idInput.type = 'text';
                idInput.className = 'mappingId';
                idInput.placeholder = 'League ID (e.g. 4328)';
                idInput.value = '';

                var delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.textContent = '✖';
                delBtn.onclick = function () {
                    row.remove();
                };

                row.appendChild(nameInput);
                row.appendChild(idInput);
                row.appendChild(delBtn);
                list.appendChild(row);
            }
        };

        // Save handler (preserve all previous on Save, validate inputs)
        document.querySelector('.TheSportsDBConfigForm').addEventListener('submit', function (e) {
            e.preventDefault();
            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(TheSportsDBConfigurationPage.pluginId).then(function (config) {
                config.ApiKey = document.getElementById('TheSportsDBApiKey').value;

                // Always collect all rows
                var newMappings = [];
                document.querySelectorAll('.mappingItem').forEach(function (row) {
                    var name = row.querySelector('.mappingName').value.trim();
                    var id = row.querySelector('.mappingId').value.trim();
                    // Validate: non-empty and numeric id only
                    if (name && /^\d+$/.test(id)) {
                        newMappings.push({ Name: name, LeagueId: id });
                    }
                });
                config.LeagueMappings = newMappings;

                ApiClient.updatePluginConfiguration(TheSportsDBConfigurationPage.pluginId, config).then(function (result) {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                    // After save, re-render to keep UI in sync
                    TheSportsDBConfigurationPage.update(document);
                });
            }).finally(function () {
                Dashboard.hideLoadingMsg();
            });
        });

        // On page show, load and render mappings
        document.addEventListener('DOMContentLoaded', function () {
            TheSportsDBConfigurationPage.update(document);
        });
    </script>
</div>